## 一、服务器环境搭建

###  dockerfile

基于ubuntu:20.04镜像，安装编译环境与ssh服务。

```dockerfile
FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y openssh-server bison build-essential curl flex g++-multilib gcc-multilib gnupg gperf lib32z-dev lib32z1 libc6-dev-i386 libgl1-mesa-dev libncurses5 lib32ncurses5-dev libssl-dev libx11-dev libxml2-utils m4 unzip x11proto-core-dev xsltproc zip zlib1g-dev bsdmainutils cgpt libswitch-perl bc rsync xxd git-core parallel python openjdk-8-jdk
RUN mkdir /run/sshd;echo 'root:123456' | chpasswd;sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config;sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
RUN git config --global color.ui true;git config --global pull.rebase true ;git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --"
ADD repo /usr/bin/
ADD repo_mtk.git /opt/repo_mtk.git
CMD ["/usr/sbin/sshd", "-D"]
```

### 构建镜像

```bash
docker build -f <dockerfile> -t <image_name>:<tag> .
```


### 创建容器

```bash
docker run -itd -p 2201:22 -h pengyujie --name pengyujie -v /intel_p5510/Project:/root/Project aa304c218870
```

```bash
#!/bin/bash

# 用户与端口的对应关系
declare -A port_map=(
    ["wushiyong"]=2201
    ["xujing"]=2202
    ["pengyujie"]=2203
    ["zhengjingjing"]=2204
    ["tanwei"]=2205
    ["yangzhao"]=2206
    ["liqiongying"]=2207
    ["liuxiaoling"]=2208
    ["zhoushaohong"]=2209
    ["renyan"]=2210
    ["songwei"]=2211
    ["zhangminghui"]=2212
    ["shaoyu"]=2213
    ["wuyurong"]=2214
    ["wangjintao"]=2215
    ["feixingming"]=2216
    ["yuxiaowen"]=2217
    ["lizonghao"]=2218
    ["public"]=2299
)

# 循环遍历用户列表
for user in "${!port_map[@]}"
do
    # 获取用户对应的端口号
    port="${port_map[$user]}"
    
    # 创建容器，将指定的端口号分配给容器
    docker run -itd -p "$port":22 -h "docker-$user" --name "$user" -v "/pool_sn640/userDir/$user:/root/$user" -v "/pool_sn640/userDir/share:/root/share" your_image_name
    
    docker exec "$user" git config --global user.name "$user"
    docker exec "$user" git config --global user.email "$user@nbbsw.com"

    
    # 打印端口与用户的对应关系
    echo "User: $user, Port: $port"
done

```

## 二、如何使用

1. **使用自己的容器：** 请确保您只在分配给您的Docker容器上进行编译任务。这有助于保证资源公平分配，并防止您的工作影响其他人。
2. **保存工作：** 对于在容器中进行的所有工作，请在属于你的工作目录下进行。Docker容器被设计为易于启动和删除，如果容器被重启或删除，容器中的所有其他数据都将丢失。

| 用户          | 端口号 |
| ------------- | ------ |
| wushiyong     | 2201   |
| xujing        | 2202   |
| pengyujie     | 2203   |
| zhengjingjing | 2204   |
| tanwei        | 2205   |
| yangzhao      | 2206   |
| liqiongying   | 2207   |
| liuxiaoling   | 2208   |
| zhoushaohong  | 2209   |
| renyan        | 2210   |
| songwei       | 2211   |
| zhangminghui  | 2212   |
| shaoyu        | 2213   |
| wuyurong      | 2214   |
| wangjintao    | 2215   |
| feixingming   | 2216   |
| yuxiaowen     | 2217   |
| lizonghao     | 2218   |
| public        | 2299   |


在上表中查找到自己的用户，将port替换为分配到的端口号，没有需要添加可以联系彭誉洁。

#### 1、添加密钥

```bash
scp -P $port -r ~/.ssh root@172.20.101.200:~/
#默认密码123456
```

#### 2、添加公钥认证

```bash
ssh root@172.20.101.200 -p $port 'cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys'
```

#### 3、登录到服务器

```bash
ssh root@172.20.101.200 -p $port
```

#### 4、注意事项以及目录说明

###### 		登录后查看主机名称是否正确

```bash
hostname
#docker-pengyujie
```

###### 		当前目录下会有两个文件夹，用户工作目录和共享工作目录

```bash
pwd
#pengyujie  share
```

- **在这两个路径下的文件才会永久保存，请在这两个目录下拉代码**。
- **用户目录是私有的，其他用户无法访问。**
- **share目录是公有的，所有用户都能访问。**
